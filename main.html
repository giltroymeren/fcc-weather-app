<!DOCTYPE HTML>
<!--
    FreeCodeCamp: Show the Local Weather
    https://www.freecodecamp.com/challenges/show-the-local-weather
-->
<html>
    <head>
        <title>Weather App</title>
        <meta charset="utf-8" />

        <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
    </head>

    <body>
        <section>
            <header>
                <h1>Weather App</h1>
            </header>
            <div>
                <h2 id="location"></h2>
                <h2>
                    <span id="temp-value"></span>&deg;<span id="temp-unit">C</span>
                </h2>
                <div id="icon"></div>
            </div>
        </section>

        <script type="text/javascript">
            // http://stackoverflow.com/a/28792224
            var geocoder;
            var city, country, weather;
            var latitude, longitude, temperature;

            function onSuccess(position) {
                lat = position.coords.latitude;
                lng = position.coords.longitude;
                setAndGetLocation(lat, lng);
            }

            function onError(position) {
                console.error("Failure to access geolocation.");
            }

            function initialize() {
                geocoder = new google.maps.Geocoder();
                var latlng  = new google.maps.LatLng(35.652832, 139.839478);
            }

            function setAndGetLocation(latitude, longitude) {
                var coordinates = new google.maps.LatLng(latitude, longitude);
                geocoder.geocode({latLng: coordinates}, function(result, status) {
                    if(status == google.maps.GeocoderStatus.OK) {
                        city = result[0].address_components[1].short_name;
                        country = result[0].address_components[4].short_name;

                        document.getElementById("location").innerHTML =
                            city + ", " + country;

                        setAndGetWeatherAndTemp(latitude, longitude);
                    } else {
                        console.error("Geocoder failed because of " + status);
                    }
                });
            }

            function getWeather(latitude, longitude, callback) {
                // http://stackoverflow.com/a/16825593
                var request = new XMLHttpRequest();
                request.onload = function() {
                    if(request.readyState === 4 && request.status === 200) {
                        callback(request.responseText);
                    } else {
                        console.error("XMLHttpRequest NOK " + request.status);
                    }
                };
                var API_KEY_OPENWEATHER = "bb209e1daadb77216092394ad80fb386";
                request.open("GET",
                    "http://api.openweathermap.org/data/2.5/weather?lat=" + latitude +
                    "&lon=" + longitude + "&APPID=" + API_KEY_OPENWEATHER +
                    "&units=metric",
                    true);
                request.send();
            };

            function setWeatherIcon(weather, icon) {
                console.log(weather + " " + icon);
                document.getElementById("icon").innerHTML = icon;
                document.getElementById("icon").innerHTML =
                    '<img src="' + icon + ' alt=' + weather + '>';
            }

            function setTemperature(temp) {
                document.getElementById("temp-value").innerHTML = temp;
            }

            function setAndGetWeatherAndTemp(latitude, longitude) {
                // callbacks with parameters, cheers!
                getWeather(latitude, longitude, function(result) {
                    var data = JSON.parse(result);
                    weather = data["weather"][0]["main"];
                    var icon = "http://openweathermap.org/img/w/" +
                        data["weather"][0]["icon"] + ".png"
                    temperature = data["main"].temp;

                    setWeatherIcon(weather, icon);
                    setTemperature(temperature);
                });
            }

            // https://gist.github.com/marchawkins/9755430
            google.maps.event.addDomListener(window, 'load', initialize);

            document.addEventListener('DOMContentLoaded', function(event) {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(onSuccess, onError);
                }
            });
        </script>
    </body>
</html>
